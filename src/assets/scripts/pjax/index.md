# index.ts 仕様書

## 🎯 目的
PJAXシステム全体の統合・初期化・制御を担当するメインエントリーポイントとして、シンプルで使いやすいAPIを提供する

## 📋 実装要件

### メインクラス設計
**クラス名**: `SimplePJAX`
**役割**: PJAX機能の統合制御とユーザーインターフェース

### コンストラクタ要件
**引数**: `options?: Partial<PJAXOptions>`
**初期化内容**:
- デフォルトオプションとユーザーオプションのマージ
- PJAXRouter インスタンスの生成
- 初期化状態の設定

### プライベートプロパティ
- `router`: PJAXRouter インスタンス
- `options`: 最終的な設定オプション
- `isInitialized`: 初期化完了フラグ

## 🚀 公開メソッド仕様

### init メソッド (中核機能)
**メソッド名**: `init`
**引数**: なし
**戻り値**: `void`
**目的**: PJAX システムの初期化と動作開始

**処理フロー**:
1. 重複初期化のチェック
2. DOM読み込み状態の確認
3. DOMContentLoaded イベント待機 (必要に応じて)
4. イベントリスナーの設定
5. 初期化完了フラグの更新
6. ログ出力

**イベントリスナー設定内容**:
- `click` イベント: ページ全体のリンククリック監視
- `popstate` イベント: ブラウザ戻る/進むボタン対応
- `beforeunload` イベント: ページ離脱時のクリーンアップ

### watchLinks メソッド (private)
**目的**: リンククリックの監視と制御
**処理内容**:
1. イベント委譲によるクリック監視
2. クリックされた要素の特定
3. aタグ（リンク）の判定
4. PJAX処理対象かの判定
5. 通常のリンク動作の停止
6. PJAXナビゲーションの実行

**判定条件**:
- aタグであること
- data-pjax="false" 属性を持たないこと（デフォルトで全て処理）
- 同一ドメインのリンクであること
- 特殊キー (Ctrl/Meta/Shift) が押されていないこと
- target="_blank" でないこと

### loadPage メソッド (private)
**目的**: 実際のページ読み込み処理
**処理フロー**:
1. ロード開始ログ
2. fetch API による HTTP リクエスト
3. レスポンスの HTML 取得
4. DOMParser による HTML 解析
5. コンテンツ部分の抽出
6. 現在のコンテンツとの置換
7. URL とタイトルの更新
8. ロード完了ログ

**エラーハンドリング**:
- ネットワークエラー → 通常のページ遷移にフォールバック
- 解析エラー → 通常のページ遷移にフォールバック
- タイムアウト → 通常のページ遷移にフォールバック

## 🔧 統合機能仕様

### RouterとのAPI統合
**連携内容**:
- PJAXRouter の navigate メソッド呼び出し
- エラーハンドリングのプロキシ
- 成功時のコールバック処理

### 簡単な初期化API
**パターン1 - 基本初期化**:
```javascript
const pjax = new SimplePJAX()
pjax.init()
```

**パターン2 - カスタム設定**:
```javascript
const pjax = new SimplePJAX({
  timeout: 3000,
  debug: true
})
pjax.init()
```

## 📋 実装優先度

### Phase 1 (必須 - 基本機能)
1. クラス基本構造とコンストラクタ
2. `init` メソッド (シンプル版)
3. `watchLinks` メソッド (基本版)
4. `loadPage` メソッド (基本版)
5. イベントリスナーの設定

### Phase 2 (推奨 - 機能強化)
1. 詳細なエラーハンドリング
2. PJAXRouter との完全統合
3. デバッグログの充実
4. パフォーマンス計測

### Phase 3 (オプション - 高度機能)
1. プログレスバー表示
2. カスタムイベント発火
3. プリロード機能
4. アナリティクス連携

## 🛠️ Ministaフレームワーク統合

### HTMLマークアップ要件
**global.tsx での設定**:
- Header/Footer は固定（更新対象外）
- `data-pjax-container` でメインコンテンツをマーク
- 除外したいリンクには `data-pjax="false"` 属性を追加（デフォルトで全リンク対象）

**推奨HTMLストラクチャ**:
```html
<body>
  <header>
    <nav>
      <a href="/">Home</a>
      <a href="/about">About</a>
      <a href="/external" data-pjax="false">External Link</a>
    </nav>
  </header>
  
  <main data-pjax-container>
    <!-- この部分がPJAXで更新される -->
    {children}
  </main>
  
  <footer>
    <!-- 固定部分 -->
  </footer>
</body>
```

### scripts/index.ts での初期化
**自動初期化の実装**:
```javascript
// メインスクリプトファイルでの自動実行
import SimplePJAX from './pjax/index'

// ページロード時に自動初期化
document.addEventListener('DOMContentLoaded', () => {
  const pjax = new SimplePJAX({
    debug: process.env.NODE_ENV === 'development'
  })
  pjax.init()
})
```

## 🚨 設計指針

### シンプルさの維持
- 最小限のAPIでの使いやすさ
- 複雑な設定は内部で自動処理
- エラー時の自動フォールバック

### パフォーマンス重視
- イベント委譲による効率的な監視
- 不要な処理の最小化
- メモリリークの防止

### 段階的劣化
- JavaScript 無効時は通常のリンク動作
- PJAX失敗時は通常のページ遷移
- プログレッシブエンハンスメント

## 🧪 テスト要件

### 基本機能テスト
- 初期化処理の確認
- リンククリックの監視
- ページ遷移の動作確認

### エラーハンドリングテスト
- ネットワークエラー時の動作
- 不正なHTMLレスポンス時の動作
- 存在しないページへのアクセス

### ブラウザ互換性テスト
- モダンブラウザでの動作確認
- レガシーブラウザでの段階的劣化
- モバイルブラウザでの動作確認

---
*ファイル優先度: 🔴 最高 (システム全体のエントリーポイント)*
*依存関係: router.ts (他の全ファイルを間接的に依存)*
*推定作業時間: 1-2時間*
*テスト要件: E2Eテストによる全体統合テスト必須*