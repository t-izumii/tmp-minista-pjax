# cache.ts 仕様書

## 🎯 目的
メモリベースのページキャッシュ機能を提供し、LRU方式による効率的な容量管理と高速なページ復元を実現する

## 📋 実装要件

### メインクラス設計
**クラス名**: `PageCache`
**役割**: ページコンテンツのメモリキャッシュ管理

### コンストラクタ要件
**引数**: `maxSize: number` (デフォルト: 10)
**初期化内容**:
- キャッシュMap の初期化
- アクセス順序配列の初期化
- 統計情報オブジェクトの初期化
- デフォルト有効期限の設定

### プライベートプロパティ
- `cache`: キャッシュエントリのMap
- `maxSize`: 最大キャッシュ容量
- `accessOrder`: LRU管理用のURL配列
- `stats`: ヒット/ミス統計情報
- `defaultExpiry`: デフォルト有効期限 (5分)

## 🚀 公開メソッド仕様

### get メソッド
**メソッド名**: `get`
**引数**: `url: string`
**戻り値**: `PageContent | null`
**目的**: 指定URLのキャッシュエントリを取得

**処理内容**:
1. URL正規化
2. キャッシュエントリの存在確認
3. 有効期限のチェック
4. 期限切れの場合は削除してnull返却
5. 有効な場合はヒット統計更新
6. LRUアクセス順序の更新
7. ディープコピーしたコンテンツを返却

### set メソッド
**メソッド名**: `set`
**引数**: `url: string, content: PageContent`
**戻り値**: `void`
**目的**: 指定URLのページコンテンツをキャッシュに保存

**処理内容**:
1. URL正規化
2. 容量チェック (満杯時はLRU削除)
3. CacheEntryオブジェクト作成
4. キャッシュへの保存
5. LRUアクセス順序の更新

### has メソッド
**メソッド名**: `has`
**引数**: `url: string`
**戻り値**: `boolean`
**目的**: 指定URLの有効なキャッシュが存在するかチェック

### delete メソッド
**メソッド名**: `delete`
**引数**: `url: string`
**戻り値**: `boolean`
**目的**: 指定URLのキャッシュエントリを削除

### clear メソッド
**メソッド名**: `clear`
**引数**: なし
**戻り値**: `void`
**目的**: 全キャッシュエントリの削除

### getStats メソッド
**メソッド名**: `getStats`
**引数**: なし
**戻り値**: `CacheStats`
**目的**: キャッシュ統計情報の取得

**統計内容**:
- 現在のエントリ数
- 最大容量
- ヒット率 (0-1の範囲)
- 総ヒット数
- 総ミス数

## 🔧 プライベートメソッド仕様

### LRU管理メソッド
**updateAccessOrder**: アクセス順序配列の更新
**evictLeastRecentlyUsed**: 最古エントリの削除

### ユーティリティメソッド
**normalizeUrl**: URL正規化 (クエリ・ハッシュ除去)
**isExpired**: 有効期限チェック

## 🚀 オプション機能

### 容量管理メソッド
**メソッド名**: `resize`
**引数**: `newMaxSize: number`
**目的**: キャッシュ最大容量の変更

### 有効期限管理メソッド
**メソッド名**: `updateExpiry`
**引数**: `url: string, expiryMs?: number`
**目的**: 特定エントリの有効期限延長

**メソッド名**: `setDefaultExpiry`
**引数**: `expiryMs: number`
**目的**: デフォルト有効期限の設定

### メンテナンスメソッド
**メソッド名**: `cleanup`
**戻り値**: `number` (削除数)
**目的**: 期限切れエントリの一括削除

**メソッド名**: `analyzeEfficiency`
**戻り値**: 効率性分析結果オブジェクト
**内容**: 平均ヒット数、最頻アクセスURL等

## 📋 実装優先度

### Phase 1 (必須 - 基本機能)
1. クラス基本構造とコンストラクタ
2. `get`, `set`, `has`, `delete`, `clear` メソッド
3. `getStats` メソッド
4. LRU管理の基本機能

### Phase 2 (推奨 - 機能向上)
1. 有効期限管理機能
2. URL正規化処理
3. `cleanup` メソッド
4. 統計情報の充実

### Phase 3 (オプション - 高度機能)
1. `resize`, `updateExpiry` メソッド
2. 効率性分析機能
3. デバッグ・モニタリング機能
4. パフォーマンス最適化

## 🛠️ 設計指針

### メモリ効率
- エントリサイズの最適化
- 不要な参照の削除
- ガベージコレクション対応

### LRU実装
- O(1) でのアクセス順序更新
- 効率的な最古エントリ特定
- メモリ使用量の予測可能性

### 拡張性
- 異なる削除戦略への対応
- 永続化機能への拡張可能性
- マルチスレッド対応の基盤

---
*ファイル優先度: 🟡 中 (パフォーマンス向上)*
*依存関係: types.ts, utils.ts*
*推定作業時間: 1.5-2時間*
*テスト要件: LRU動作・有効期限の単体テスト必須*